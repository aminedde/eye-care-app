name: Build EyeCare App

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'requirements.txt'
  release:
    types: [ created ]

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Create icon
        shell: python
        run: |
          from PIL import Image, ImageDraw
          
          sizes = [16, 32, 48, 64, 128, 256]
          images = []
          
          for size in sizes:
              img = Image.new('RGBA', (size, size), (0, 0, 0, 0))
              draw = ImageDraw.Draw(img)
              s = size / 64
              
              # Green circle background
              draw.ellipse(
                  [int(2*s), int(2*s), int(62*s), int(62*s)], 
                  fill='#4CAF50', 
                  outline='#2E7D32', 
                  width=max(1, int(2*s))
              )
              
              # Eye white
              draw.ellipse(
                  [int(10*s), int(20*s), int(54*s), int(44*s)], 
                  fill='white', 
                  outline='#1a1a1a', 
                  width=max(1, int(1*s))
              )
              
              # Pupil
              draw.ellipse(
                  [int(25*s), int(26*s), int(39*s), int(38*s)], 
                  fill='#1a1a1a'
              )
              
              # Highlight
              draw.ellipse(
                  [int(29*s), int(28*s), int(35*s), int(34*s)], 
                  fill='white'
              )
              
              images.append(img)
          
          images[0].save(
              'icon.ico', 
              format='ICO', 
              sizes=[(s, s) for s in sizes], 
              append_images=images[1:]
          )
      
      - name: Build EXE
        run: |
          pyinstaller --onefile --windowed --name "EyeCare" --icon=icon.ico src/eye_care.py
      
      - name: Rename output
        run: |
          move "dist\EyeCare.exe" "dist\EyeCare-Windows.exe"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EyeCare-Windows
          path: dist/EyeCare-Windows.exe
          retention-days: 30
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/EyeCare-Windows.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          pyinstaller --onefile --windowed --name "EyeCare-Linux" src/eye_care.py
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: 护眼卫士-Linux
          path: dist/EyeCare-Linux
          retention-days: 30
